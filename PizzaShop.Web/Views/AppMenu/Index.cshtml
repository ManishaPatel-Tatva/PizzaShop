@using PizzaShop.Entity.ViewModels
@model AppMenuViewModel

@{
    ViewData["Title"] = "Menu";
    Layout = "_OrderAppLayout";
}

<!-- Sidebar starts-->
<div class="menu-sidebar" id="menu-sidebar">
    <!-- Categories heading tab starts-->
    <div class="bg-white">
        <div class="fs-5 fw-semibold m-2 ps-2 text-center text-md-start">Category</div>
        <ul class="nav nav-pills app-categories d-flex flex-row flex-md-column flex-nowrap overflow-auto" id="pills-tab"
            role="tablist">

            <li class="nav-item mb-2 my-md-0" role="presentation">
                <button class="btn-category nav-link p-2 w-100 text-start" id="tab-fav" data-bs-toggle="pill"
                    type="button" role="tab" aria-controls="pills-profile" aria-selected="false" data-id="-1"
                    onclick="CardsAjax(-1)">
                    <span class="fs-6 tab-text text-nowrap px-2">Favourite Item</span>
                </button>
            </li>

            <li class="nav-item mb-2 my-md-0" role="presentation">
                <button class="btn-category nav-link active p-2 w-100 text-start" id="tab-all" data-bs-toggle="pill"
                    type="button" role="tab" aria-controls="pills-profile" aria-selected="false" data-id="0"
                    onclick="CardsAjax(0)">
                    <span class="fs-6 tab-text text-nowrap px-2">All</span>
                </button>
            </li>

            @foreach (CategoryViewModel? category in Model.Categories)
            {
                <li class="nav-item mb-2 my-md-0" role="presentation">
                    <button class="btn-category nav-link p-2 w-100 text-start" id="tab-@category.Id" data-bs-toggle="pill"
                        type="button" role="tab" aria-controls="pills-profile" aria-selected="false" data-id="@category.Id"
                        onclick="CardsAjax(@category.Id)">
                        <span class="fs-6 tab-text text-nowrap px-2">@category.Name</span>
                    </button>
                </li>
            }

        </ul>
    </div>
    <!-- Categories heading tab ends-->
</div>
<!-- Sidebar ends-->

<!-- Main content starts-->
<div class="menu-main-content p-3">
    <div class="row mx-0">

        <!-- Menu -->
        <div class="col-12 @(Model.CustomerId == 0 ? "col-lg-12": "col-lg-7")">
            <!-- Search Box and Item Type Symbol starts-->
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-center gap-2 mb-3">

                <div class="input-group search-group">
                    <input type="search" class="form-control" placeholder="Search" name="search" id="searchQuery">
                    <button type="submit" class="input-group-text">
                        <img src="~/images/icons/search.svg" alt="">
                    </button>
                </div>

                <div class="d-flex justify-content-center gap-2">
                    <div class="text-nowrap">
                        <i class="bi bi-circle-fill text-success"></i>
                        <span>Vegetarian</span>
                    </div>
                    <div class="text-nowrap">
                        <i class="bi bi-circle-fill text-danger"></i>
                        <span>Non-Vegetarian</span>
                    </div>
                    <div class="text-nowrap">
                        <i class="bi bi-circle-fill text-warning"></i>
                        <span>Vegan</span>
                    </div>
                </div>
            </div>
            <!-- Search Box and Item Type Symbol ends-->

            <div class="d-flex flex-wrap gap-3" id="itemCards">
                <!-- Cards Partial View -->
            </div>
        </div>

        <!-- Order -->
        <div class="col-12 @(Model.CustomerId == 0 ? "d-none": "col-lg-5") flex-grow-1">
            <div class="bg-white p-2 px-3 border rounded-2 shadow-sm">

                <!-- Title starts-->
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="d-flex align-items-center gap-2">
                        <img src="/images/icons/dining-table.svg" alt="" class="bg-blue" height="40px" width="40px">
                        <div>
                            <div>@Model.SectionName</div>
                            <div>
                                <span class="fw-semibold">Table:</span>
                                <span>
                                    @foreach (string? table in Model.Tables)
                                    {
                                        <span>@table </span>
                                    }
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <img src="/images/icons/qr-code-scan.svg" alt="" class="blue p-2 border rounded-1"
                            data-bs-toggle="modal" data-bs-target="#qr-scan-modal">
                        <img src="/images/icons/person-lines-fill.svg" alt="" class="blue p-2 border rounded-1"
                            onclick="CustomerDetail(@Model.CustomerId)">
                        <img src="/images/icons/chat-left-text.svg" alt="" class="blue p-2 border rounded-1"
                            data-bs-toggle="modal" data-bs-target="#order-comment-modal">
                    </div>
                </div>
                <!-- Title ends-->

                <!-- Order Item starts -->
                <div class="table-responsive ">
                    <table class="table">
                        <thead>
                            <tr>
                                <th scope="col" class="col-6 fs-5">Item</th>
                                <th scope="col" class="col fs-5">Quantity</th>
                                <th scope="col" class="col fs-5">Amount</th>
                                <th scope="col" class="col-1"></th>
                            </tr>
                        </thead>
                        <tbody id="item-list">

                            @foreach (OrderItemViewModel? item in Model.Order.ItemsList)
                            {
                                <tr class="">
                                    <td>
                                        <div class="accordion accordion-item">
                                            <div class="accordion-item">
                                                <div class="accordion-header d-flex">
                                                    <button class="accordion-button px-0" type="button"
                                                        data-bs-toggle="collapse" data-bs-target="#collapse-@item.Id"
                                                        aria-expanded="true" aria-controls="collapseOne"
                                                        style="width: fit-content;">
                                                    </button>
                                                    <div class="ms-4 ps-1 fs-5">@item.Name</div>
                                                </div>
                                                <div id="collapse-@item.Id" class="accordion-collapse collapse show"
                                                    aria-labelledby="headingOne" data-bs-parent="#accordionExample">
                                                    <div class="accordion-body p-0">
                                                        <ul>
                                                            @foreach (ModifierViewModel? modifier in item.ModifiersList)
                                                            {
                                                                <li>
                                                                    <div class="d-flex gap-4">
                                                                        <span>@modifier.Name</span>
                                                                        <span>₹@modifier.Rate</span>
                                                                    </div>
                                                                </li>
                                                            }
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="item-quantity border d-flex align-items-center gap-0 rounded-2">
                                            <button type="button" class="btn fs-4 p-0">
                                                <i class="bi bi-dash"></i>
                                            </button>
                                            <input type="text" value="5" class="item-quantity text-center" hidden>
                                            <input type="text" value="5" class="item-quantity text-center bg-white"
                                                disabled>
                                            <button type="button" class="btn fs-4 p-0">
                                                <i class="bi bi-plus"></i>
                                            </button>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="fs-5">₹@item.Price</div>
                                        <div>₹@item.ModifiersList.Sum(m => m.Rate)</div>
                                    </td>
                                    <td>
                                        <img src="/images/icons/trash.svg" alt="">
                                    </td>
                                </tr>
                            }


                        </tbody>
                    </table>
                </div>
                <!-- Order Item ends -->

                <div class="table-responsive">
                    <table class="table table-borderless menu-tax-table ">
                        <tr>
                            <td class="text-start fs-5">Subtotal</td>
                            <td class="text-end fs-5">₹@Model.Order.Subtotal</td>
                        </tr>
                        @foreach (var tax in Model.Taxes.Where(t => t.IsEnabled && t.DefaultTax))
                        {
                            <tr>
                                <td class="text-start">@tax.Name</td>
                                <td class="text-end">₹@tax.TaxValue</td>
                            </tr>
                        }

                        @foreach (var tax in Model.Taxes.Where(t => t.IsEnabled && !t.DefaultTax))
                        {
                            <tr>
                                <td class="text-start">
                                    <input type="checkbox" class="form-check-input me-2" id="@tax.Id">@tax.Name
                                </td>
                                <td class="text-end">₹@tax.TaxValue</td>
                            </tr>
                        }

                        <tr>
                            <td class="text-start fs-5">Total</td>
                            <td class="text-end fs-5">₹@Model.Order.FinalAmount</td>
                        </tr>
                        <tr>
                            <td class="text-start">Payment Method</td>
                            <td class="text-end d-flex justify-content-end flex-wrap">
                                @foreach (var method in Model.PaymentMethods)
                                {
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="radio-@method.Id" name="optradio"
                                            value="@method.Id" checked>@method.Name
                                        <label class="form-check-label" for="radio1"></label>
                                    </div>
                                }
                            </td>
                        </tr>
                    </table>
                </div>

                <div class="menu-order-bottom d-flex justify-content-end gap-2 mb-2 flex-wrap">
                    <button class="btn btn-blue ">
                        Save
                    </button>
                    <button class="btn btn-white ">
                        Complete
                    </button>
                    <button class="btn btn-white text-nowrap">
                        Generate Invoice
                    </button>
                </div>

                <div class="menu-order-bottom d-flex justify-content-end">
                    <button class="btn btn-white ">
                        Cancel
                    </button>
                </div>


            </div>
        </div>

    </div>

</div>
<!-- Main Content ends -->


<!-- #region Modals---------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------->

<!-- Modal Item Detail starts -->
<div class="modal fade" id="itemDetail" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" id="itemDetailContent">
            <!-- Item Detail Partial View -->
        </div>
    </div>
</div>
<!-- Modal Item Detail ends -->

<!-- Modal QR Scan starts-->
<div class="modal fade" id="qr-scan-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5">Menu</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-center">
                    <img src="/images/qr-code.png" alt="" height="250px" width="250px">
                </div>
            </div>
            <div class="modal-footer d-flex justify-content-center">
                <button type="button" class="btn btn-white" data-bs-dismiss="modal">Done</button>
            </div>
        </div>
    </div>
</div>
<!-- Modal QR Scan ends-->

<!-- Modal Customer Detail starts -->
<div class="modal fade" id="customer-detail-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" id="customer-detail-content">
            <!-- Customer Detail Partial View -->
        </div>
    </div>
</div>
<!-- Modal Customer Detail ends -->

<!-- Modal Order Comment starts-->
<div class="modal fade" id="order-comment-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5">Order Wise Comment</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="form-floating mb-3">
                    <textarea asp-for="Order.Comment" class="form-control" rows="4" placeholder=""></textarea>
                    <label asp-for="Order.Comment">Comments*</label>
                    <span asp-validation-for="Order.Comment" class="text-danger"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-blue">Save</button>
                <button type="reset" class="btn btn-white">Cancel</button>
            </div>
        </div>
    </div>
</div>
<!-- Modal Order Comment ends-->

<!-- #endregion ----------------------------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------->


@section Scripts {

    @* Cards ajax *@
    <script>

        let activeCategory = 0;

        $(document).on("input", "#searchQuery", function () {
            CardsAjax(activeCategory);
        });


        $(document).ready(function () {
            CardsAjax(0);
        });

        function CardsAjax(categoryId) {
            activeCategory = categoryId;
            $.ajax({
                url: '@Url.Action("GetCards", "AppMenu")',
                type: "GET",
                data: {
                    categoryId: categoryId,
                    search: $("#searchQuery").val()
                },
                dataType: "html",
                success: function (data) {
                    $("#itemCards").html(data);
                },
                error: function (data) {
                    alert("No Card Found");
                }
            });
        }
    </script>

    @* Favourite Item *@
    <script>

        function FavItem(itemId) {
            console.log("FavItem", itemId);
            $.ajax({
                url: '@Url.Action("FavouriteItem", "AppMenu")',
                data: {
                    itemId: itemId
                },
                type: "POST",
                success: function (response) {
                    if (response.success) {
                        toastr.success(response.message);
                        CardsAjax(activeCategory);
                    }
                    else {
                        toastr.error(response.message);
                    }
                },
                error: function () {
                    alert("Not Done");
                }

            })
        }

    </script>

    @* Item Detail Modal *@
    <script>
        let currentItemId = 0;
        let currentItemName = "";
        let currentItemPrice = 0;
        let modifierList = [];

        let item = {
            Id: currentItemId,
            Name: currentItemName,
            Price: currentItemPrice,
            ModifiersList: modifierList
        }

        function ItemDetail(tag) {
            currentItemId = $(tag).data("id");
            currentItemName = $(tag).data("name");
            currentItemPrice = $(tag).data("price");

            item = {
                Id: currentItemId,
                Name: currentItemName,
                Price: currentItemPrice,
                ModifiersList: modifierList
            }

            $.ajax({
                url: '@Url.Action("ItemDetail", "AppMenu")',
                type: "GET",
                data: {
                    itemId: currentItemId
                },
                dataType: "html",
                success: function (data) {
                    $("#itemDetail").modal("show");
                    $("#itemDetailContent").html(data);
                },
                error: function (data) {
                    alert("No Item Found");
                }
            });
        }

        @* Select Modifier *@
            function SelectModifier(tag) {
                let modifierId = $(tag).data("id");
                let modifierName = $(tag).data("name");
                let modifierPrice = $(tag).data("price");

                $(tag).toggleClass("modifier-card-selected");

                if (!modifierList.some(m => m.Id == modifierId)) {
                    modifierList.push({
                        Id: modifierId,
                        Name: modifierName,
                        Rate: modifierPrice
                    });
                }
                else {
                    modifierList = modifierList.filter(m => m.Id != modifierId);
                }

                @* item.ModifiersList = modifierList; *@
                console.log(item);
            }

    </script>

    @* Add Item to Order *@
    <script>
        function AddItem()
        {
            console.log("AddItem : Item is ",item);
            $.ajax({
                url: '@Url.Action("AddItem","AppMenu")',
                type: "POST",
                data: {
                    item : item
                },
                dataType: "html",
                success: function(data){
                    console.log(data);
                    $("#itemDetail").modal("hide");
                    $("#item-list").append(data);
                }

            });
        }
    </script>

    @* Customer Detail Modal *@
    <script>

        function CustomerDetail(id) {
            $.ajax({
                url: '@Url.Action("GetById", "Customers")',
                type: "GET",
                data: {
                    id: id
                },
                dataType: "html",
                success: function (data) {
                    $("#customer-detail-modal").modal("show");
                    $("#customer-detail-content").html(data);
                },
                error: function (data) {
                    alert("No Item Found");
                }
            });
        }
    </script>

    @* Update Customer Detail Form Submit *@
    <script>
        $(document).on("submit", "#customerForm", function (e) {
            e.preventDefault();

            $.ajax({
                url: $(this).attr("action"),
                type: $(this).attr("method"),
                data: $(this).serialize(),
                success: function (response) {
                    if (response.success) {
                        $("#customer-detail-modal").modal("hide");
                        toastr.success(response.message);
                    }
                    else {
                        toastr.error(response.message);
                    }
                },
                error: function () {
                    console.log("There is error.Not successful");
                }
            });
        });
    </script>

}